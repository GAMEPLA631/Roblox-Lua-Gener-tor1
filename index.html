<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Lua Generátor</title>
    <!-- Tailwind CSS CDN pre jednoduché a elegantné štýly -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Používanie fontu Inter pre moderný vzhľad -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-2xl flex flex-col h-[80vh] sm:h-[70vh]">
        <div class="flex-grow flex flex-col overflow-hidden">
            <h1 class="text-3xl font-bold text-center mb-4 text-emerald-400">Roblox AI Chat</h1>
            <p class="text-center text-gray-400 mb-6">Napíšte, aký model chcete vygenerovať, a ja vám vytvorím kód pre Roblox Studio.</p>

            <!-- Oblasť chatu s automatickým rolovaním -->
            <div id="chat-container" class="flex-grow overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                <!-- Správy budú pridané sem cez JavaScript -->
            </div>
        </div>

        <!-- Vstupné pole a tlačidlo na odoslanie -->
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <!-- Výber AI kategórie -->
            <select id="ai-category"
                    class="bg-gray-700 text-gray-100 p-3 rounded-lg border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500 focus:ring-opacity-50 transition-colors duration-200">
                <option value="classic">1. Classic Model AI (Jednoduché modely)</option>
                <option value="builder">2. Builder AI (Stavby a štruktúry)</option>
                <option value="terrain">3. Terrain AI (Mapy a krajina)</option>
                <option value="functional">4. Functional AI (S funkčnosťou)</option>
                <option value="pro" selected>5. Pro AI (Komplexné modely)</option>
            </select>
            <input type="text" id="user-input" placeholder="Napríklad: 'vytvor jednoduchú červenú kocku'"
                   class="flex-grow bg-gray-700 text-gray-100 p-3 rounded-lg border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500 focus:ring-opacity-50 transition-colors duration-200"
                   onkeydown="if(event.key === 'Enter') sendMessage()">
            <button id="send-button" onclick="sendMessage()"
                    class="bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-600 transition-colors duration-200 flex-shrink-0">
                Odoslať
            </button>
        </div>

        <!-- Indikátor načítavania (skrytý na začiatku) -->
        <div id="loading-indicator" class="mt-4 text-center text-gray-400 hidden">
            Generujem kód... <span class="animate-pulse">...</span>
        </div>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
    </style>

    <script>
        // DOM elementy
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sendButton = document.getElementById('send-button');
        const aiCategorySelect = document.getElementById('ai-category');

        // Nastavenia limitu
        const GENERATION_LIMIT = 3;
        const LIMIT_COOLDOWN = 3600000; // 1 hodina v milisekundách

        // Funkcia na kontrolu a správu limitu
        function checkGenerationLimit() {
            let limitData = JSON.parse(localStorage.getItem('generationLimitData') || '{}');
            const now = Date.now();

            // Ak uplynula hodina od poslednej generácie, resetujeme limit
            if (!limitData.lastGenerationTimestamp || (now - limitData.lastGenerationTimestamp > LIMIT_COOLDOWN)) {
                limitData = { count: 0, lastGenerationTimestamp: now };
                localStorage.setItem('generationLimitData', JSON.stringify(limitData));
            }
            
            // Kontrola, či počet generácií neprekročil limit
            return limitData.count >= GENERATION_LIMIT;
        }

        // Funkcia na inkrementáciu počítadla generácií
        function incrementGenerationCount() {
            let limitData = JSON.parse(localStorage.getItem('generationLimitData') || '{}');
            limitData.count = (limitData.count || 0) + 1;
            limitData.lastGenerationTimestamp = Date.now();
            localStorage.setItem('generationLimitData', JSON.stringify(limitData));
        }

        // Funkcia na aktualizáciu UI podľa stavu limitu
        function updateUIForLimit() {
            const isLimitReached = checkGenerationLimit();
            const selectedCategory = aiCategorySelect.value;
            const isRestrictedCategory = selectedCategory !== 'classic';

            if (isLimitReached && isRestrictedCategory) {
                aiCategorySelect.value = 'classic';
                addMessage('ai', 'Dosiahli ste limit 3 modelov za hodinu. Momentálne môžete používať iba "Classic Model AI". Limit sa resetuje o 1 hodinu.');
            }
        }

        // Volanie funkcie pri načítaní stránky na kontrolu stavu
        window.addEventListener('load', updateUIForLimit);
        aiCategorySelect.addEventListener('change', updateUIForLimit);

        // Funkcia na pridanie správy do chatu
        function addMessage(sender, message, isCode = false) {
            const messageDiv = document.createElement('div');
            let senderClass, messageContent;

            if (sender === 'user') {
                senderClass = 'flex justify-end';
                messageContent = `<div class="bg-gray-700 text-white p-3 rounded-lg max-w-[80%] break-words shadow-sm">${message}</div>`;
            } else {
                senderClass = 'flex justify-start';
                if (isCode) {
                    messageContent = `
                        <div class="bg-gray-700 p-4 rounded-lg max-w-[90%] shadow-sm">
                            <p class="text-sm font-semibold text-gray-400 mb-2">Skopírujte a vložte do Command Bar v Roblox Studio:</p>
                            <pre class="whitespace-pre-wrap overflow-x-auto text-sm font-mono bg-gray-900 p-3 rounded-md text-emerald-300">${message}</pre>
                            <button class="mt-2 text-xs text-white bg-emerald-600 px-3 py-1 rounded-md hover:bg-emerald-700 transition-colors" onclick="copyCode(this)">
                                Skopírovať príkaz
                            </button>
                        </div>
                    `;
                } else {
                    messageContent = `<div class="bg-gray-700 text-white p-3 rounded-lg max-w-[80%] break-words shadow-sm">${message}</div>`;
                }
            }
            
            messageDiv.className = senderClass;
            messageDiv.innerHTML = messageContent;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Funkcia na kopírovanie kódu do schránky
        function copyCode(button) {
            const pre = button.previousElementSibling;
            const range = document.createRange();
            range.selectNode(pre);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                const successful = document.execCommand('copy');
                button.textContent = successful ? 'Skopírované!' : 'Zlyhalo...';
                setTimeout(() => button.textContent = 'Skopírovať príkaz', 2000);
            } catch (err) {
                console.error('Kopírovanie zlyhalo:', err);
                button.textContent = 'Zlyhalo...';
            }
            window.getSelection().removeAllRanges();
        }

        // Funkcia na získanie správneho promptu pre vybranú kategóriu
        function getPromptForCategory(category, userPrompt) {
            let basePrompt = `Ste expert na Roblox a vašou jedinou úlohou je generovať komplexný, efektívny a funkčný Lua kód, ktorý sa dá vložiť priamo do Command Bar. Vygenerujte len kód, ktorý je pripravený na okamžité použitie. Tu je popis užívateľa: "${userPrompt}".`;

            switch (category) {
                case 'classic':
                    return `Ste AI určená na vytváranie jednoduchých a klasických modelov. Zamerajte sa na základné tvary, farby a materiály. Nevytvárajte zložité štruktúry ani skripty. Vytvorte len jeden alebo niekoľko jednoduchých objektov. ${basePrompt}`;
                case 'builder':
                    return `Ste AI zameraná na stavby a detailné štruktúry. Používajte WedgePart, CornerWedgePart a UnionOperation na vytvorenie presných architektonických prvkov. Zamerajte sa na budovy, múry, mosty a iné stabilné štruktúry. ${basePrompt}`;
                case 'terrain':
                    return `Ste AI pre vytváranie máp a terénov. Používajte Part, MeshPart alebo iné vhodné objekty na procedurálne generovanie krajiny, hôr, riek a lesov. Zamerajte sa na realistické alebo štylizované prostredia. ${basePrompt}`;
                case 'functional':
                    return `Ste AI, ktorá vytvára funkčné modely s hernou logikou. Vytvárajte modely, ktoré obsahujú skripty pre udalosti ako 'Touched', rotácie alebo vizuálne efekty. Zamerajte sa na interaktívne objekty. ${basePrompt}`;
                case 'pro':
                    return `Ste AI s pokročilými schopnosťami, ako napríklad ChatGPT. Vytvárajte komplexné scény a 3D modely, ktoré kombinujú procedurálne techniky, funkčné skripty, pokročilé materiály a zložité tvary. Zamerajte sa na detailné a dynamické scény, ako sú to, čo robia najlepšie modely. ${basePrompt}`;
                default:
                    return basePrompt;
            }
        }

        // Funkcia na odosielanie správy do API
        async function sendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // Kontrola limitu pred odoslaním
            const selectedCategory = aiCategorySelect.value;
            const isRestrictedCategory = selectedCategory !== 'classic';
            
            if (isRestrictedCategory && checkGenerationLimit()) {
                aiCategorySelect.value = 'classic';
                addMessage('ai', 'Dosiahli ste limit 3 modelov za hodinu pre túto kategóriu. Momentálne môžete používať iba "Classic Model AI". Limit sa resetuje o 1 hodinu.');
                return;
            }

            addMessage('user', prompt);
            userInput.value = '';
            
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            
            // Získanie správneho promptu na základe výberu kategórie
            const llmPrompt = getPromptForCategory(selectedCategory, prompt);

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: llmPrompt }] });

            const payload = { contents: chatHistory };
            // API kľúč bude automaticky poskytnutý v prostredí, nemusíte ho zadávať
            const apiKey = "AIzaSyD0OIR4P5gjUBvVJfWUSYZmQGck_aKoVv8";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const maxRetries = 3;
            let success = false;
            let resultText = "Prepáčte, niečo sa pokazilo. Skúste to prosím znova.";

            while (retries < maxRetries && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Príliš veľa požiadaviek
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        console.warn(`Príliš veľa požiadaviek. Skúšam znova za ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Chyba API: ${response.status} ${response.statusText}. Podrobnosti: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        resultText = result.candidates[0].content.parts[0].text;
                        success = true;
                    } else {
                        throw new Error("Neočakávaná štruktúra odpovede.");
                    }
                } catch (error) {
                    console.error('Chyba pri volaní API:', error);
                    retries++;
                    if (retries >= maxRetries) {
                        resultText = `Prepáčte, vyskytla sa chyba a nepodarilo sa nám vygenerovať kód. Podrobnosti: ${error.message}.`;
                        break;
                    }
                    const delay = Math.pow(2, retries) * 1000;
                    console.warn(`Chyba. Skúšam znova za ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // Inkrementácia počítadla pre obmedzené kategórie
            if (isRestrictedCategory && success) {
                incrementGenerationCount();
            }

            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            
            // Kontrola, či odpoveď obsahuje kódový blok
            const codeMatch = resultText.match(/```(lua|Lua)?\s*([\s\S]+?)\s*```/);
            if (codeMatch) {
                addMessage('ai', codeMatch[2].trim(), true);
            } else {
                addMessage('ai', resultText);
            }
        }
    </script>
</body>
</html>
