<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Lua Gener√°tor</title>
    <!-- Pridanie ikony do z√°lo≈æky prehliadaƒça -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß±</text></svg>">
    <!-- Tailwind CSS CDN pre jednoduch√© a elegantn√© ≈°t√Ωly -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pou≈æ√≠vanie fontu Inter pre modern√Ω vzhƒæad -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-2xl flex flex-col h-[80vh] sm:h-[70vh]">
        <div class="flex-grow flex flex-col overflow-hidden">
            <h1 class="text-3xl font-bold text-center mb-4 text-emerald-400">Roblox AI Chat</h1>
            <p class="text-center text-gray-400 mb-6">Nap√≠≈°te, ak√Ω model chcete vygenerova≈•, a ja v√°m vytvor√≠m k√≥d pre Roblox Studio.</p>

            <!-- Oblas≈• chatu s automatick√Ωm rolovan√≠m -->
            <div id="chat-container" class="flex-grow overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                <!-- Spr√°vy bud√∫ pridan√© sem cez JavaScript -->
            </div>
        </div>

        <!-- Vstupn√© pole a tlaƒçidlo na odoslanie -->
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <!-- V√Ωber AI kateg√≥rie -->
            <select id="ai-category"
                    class="bg-gray-700 text-gray-100 p-3 rounded-lg border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500 focus:ring-opacity-50 transition-colors duration-200">
                <option value="classic">1. Classic Model AI (Jednoduch√© modely)</option>
                <option value="builder">2. Builder AI (Stavby a ≈°trukt√∫ry)</option>
                <option value="terrain">3. Terrain AI (Mapy a krajina)</option>
                <option value="functional">4. Functional AI (S funkƒçnos≈•ou)</option>
                <option value="pro" selected>5. Pro AI (Komplexn√© modely)</option>
            </select>
            <input type="text" id="user-input" placeholder="Napr√≠klad: 'vytvor jednoduch√∫ ƒçerven√∫ kocku'"
                   class="flex-grow bg-gray-700 text-gray-100 p-3 rounded-lg border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500 focus:ring-opacity-50 transition-colors duration-200"
                   onkeydown="if(event.key === 'Enter') sendMessage()">
            <button id="send-button" onclick="sendMessage()"
                    class="bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-600 transition-colors duration-200 flex-shrink-0">
                Odosla≈•
            </button>
        </div>

        <!-- Indik√°tor naƒç√≠tavania (skryt√Ω na zaƒçiatku) -->
        <div id="loading-indicator" class="mt-4 text-center text-gray-400 hidden">
            Generujem k√≥d... <span class="animate-pulse">...</span>
        </div>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
    </style>

    <script>
        // DOM elementy
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sendButton = document.getElementById('send-button');
        const aiCategorySelect = document.getElementById('ai-category');

        // Nastavenia limitu
        const GENERATION_LIMIT = 3;
        const LIMIT_COOLDOWN = 3600000; // 1 hodina v milisekund√°ch

        // Funkcia na kontrolu a spr√°vu limitu
        function checkGenerationLimit() {
            let limitData = JSON.parse(localStorage.getItem('generationLimitData') || '{}');
            const now = Date.now();

            // Ak uplynula hodina od poslednej gener√°cie, resetujeme limit
            if (!limitData.lastGenerationTimestamp || (now - limitData.lastGenerationTimestamp > LIMIT_COOLDOWN)) {
                limitData = { count: 0, lastGenerationTimestamp: now };
                localStorage.setItem('generationLimitData', JSON.stringify(limitData));
            }
            
            // Kontrola, ƒçi poƒçet gener√°ci√≠ neprekroƒçil limit
            return limitData.count >= GENERATION_LIMIT;
        }

        // Funkcia na inkrement√°ciu poƒç√≠tadla gener√°ci√≠
        function incrementGenerationCount() {
            let limitData = JSON.parse(localStorage.getItem('generationLimitData') || '{}');
            limitData.count = (limitData.count || 0) + 1;
            limitData.lastGenerationTimestamp = Date.now();
            localStorage.setItem('generationLimitData', JSON.stringify(limitData));
        }

        // Funkcia na aktualiz√°ciu UI podƒæa stavu limitu
        function updateUIForLimit() {
            const isLimitReached = checkGenerationLimit();
            const selectedCategory = aiCategorySelect.value;
            const isRestrictedCategory = selectedCategory !== 'classic';

            if (isLimitReached && isRestrictedCategory) {
                aiCategorySelect.value = 'classic';
                addMessage('ai', 'Dosiahli ste limit 3 modelov za hodinu. Moment√°lne m√¥≈æete pou≈æ√≠va≈• iba "Classic Model AI". Limit sa resetuje o 1 hodinu.');
            }
        }

        // Volanie funkcie pri naƒç√≠tan√≠ str√°nky na kontrolu stavu
        window.addEventListener('load', updateUIForLimit);
        aiCategorySelect.addEventListener('change', updateUIForLimit);

        // Funkcia na pridanie spr√°vy do chatu
        function addMessage(sender, message, isCode = false) {
            const messageDiv = document.createElement('div');
            let senderClass, messageContent;

            if (sender === 'user') {
                senderClass = 'flex justify-end';
                messageContent = `<div class="bg-gray-700 text-white p-3 rounded-lg max-w-[80%] break-words shadow-sm">${message}</div>`;
            } else {
                senderClass = 'flex justify-start';
                if (isCode) {
                    messageContent = `
                        <div class="bg-gray-700 p-4 rounded-lg max-w-[90%] shadow-sm">
                            <p class="text-sm font-semibold text-gray-400 mb-2">Skop√≠rujte a vlo≈æte do Command Bar v Roblox Studio:</p>
                            <pre class="whitespace-pre-wrap overflow-x-auto text-sm font-mono bg-gray-900 p-3 rounded-md text-emerald-300">${message}</pre>
                            <button class="mt-2 text-xs text-white bg-emerald-600 px-3 py-1 rounded-md hover:bg-emerald-700 transition-colors" onclick="copyCode(this)">
                                Skop√≠rova≈• pr√≠kaz
                            </button>
                        </div>
                    `;
                } else {
                    messageContent = `<div class="bg-gray-700 text-white p-3 rounded-lg max-w-[80%] break-words shadow-sm">${message}</div>`;
                }
            }
            
            messageDiv.className = senderClass;
            messageDiv.innerHTML = messageContent;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Funkcia na kop√≠rovanie k√≥du do schr√°nky
        function copyCode(button) {
            const pre = button.previousElementSibling;
            const range = document.createRange();
            range.selectNode(pre);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                const successful = document.execCommand('copy');
                button.textContent = successful ? 'Skop√≠rovan√©!' : 'Zlyhalo...';
                setTimeout(() => button.textContent = 'Skop√≠rova≈• pr√≠kaz', 2000);
            } catch (err) {
                console.error('Kop√≠rovanie zlyhalo:', err);
                button.textContent = 'Zlyhalo...';
            }
            window.getSelection().removeAllRanges();
        }

        // Funkcia na z√≠skanie spr√°vneho promptu pre vybran√∫ kateg√≥riu
        function getPromptForCategory(category, userPrompt) {
            let basePrompt = `Ste expert na Roblox a va≈°ou jedinou √∫lohou je generova≈• komplexn√Ω, efekt√≠vny a funkƒçn√Ω Lua k√≥d, ktor√Ω sa d√° vlo≈æi≈• priamo do Command Bar. Vygenerujte len k√≥d, ktor√Ω je pripraven√Ω na okam≈æit√© pou≈æitie. Tu je popis u≈æ√≠vateƒæa: "${userPrompt}".`;

            switch (category) {
                case 'classic':
                    return `Ste AI urƒçen√° na vytv√°ranie jednoduch√Ωch a klasick√Ωch modelov. Zamerajte sa na z√°kladn√© tvary, farby a materi√°ly. Nevytv√°rajte zlo≈æit√© ≈°trukt√∫ry ani skripty. Vytvorte len jeden alebo niekoƒæko jednoduch√Ωch objektov. ${basePrompt}`;
                case 'builder':
                    return `Ste AI zameran√° na stavby a detailn√© ≈°trukt√∫ry. Pou≈æ√≠vajte WedgePart, CornerWedgePart a UnionOperation na vytvorenie presn√Ωch architektonick√Ωch prvkov. Zamerajte sa na budovy, m√∫ry, mosty a in√© stabiln√© ≈°trukt√∫ry. ${basePrompt}`;
                case 'terrain':
                    return `Ste AI pre vytv√°ranie m√°p a ter√©nov. Pou≈æ√≠vajte Part, MeshPart alebo in√© vhodn√© objekty na procedur√°lne generovanie krajiny, h√¥r, riek a lesov. Zamerajte sa na realistick√© alebo ≈°tylizovan√© prostredia. ${basePrompt}`;
                case 'functional':
                    return `Ste AI, ktor√° vytv√°ra funkƒçn√© modely s hernou logikou. Vytv√°rajte modely, ktor√© obsahuj√∫ skripty pre udalosti ako 'Touched', rot√°cie alebo vizu√°lne efekty. Zamerajte sa na interakt√≠vne objekty. ${basePrompt}`;
                case 'pro':
                    return `Ste AI s pokroƒçil√Ωmi schopnos≈•ami, ako napr√≠klad ChatGPT. Vytv√°rajte komplexn√© sc√©ny a 3D modely, ktor√© kombinuj√∫ procedur√°lne techniky, funkƒçn√© skripty, pokroƒçil√© materi√°ly a zlo≈æit√© tvary. Zamerajte sa na detailn√© a dynamick√© sc√©ny, ako s√∫ to, ƒço robia najlep≈°ie modely. ${basePrompt}`;
                default:
                    return basePrompt;
            }
        }

        // Funkcia na odosielanie spr√°vy do API
        async function sendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // Kontrola limitu pred odoslan√≠m
            const selectedCategory = aiCategorySelect.value;
            const isRestrictedCategory = selectedCategory !== 'classic';
            
            if (isRestrictedCategory && checkGenerationLimit()) {
                aiCategorySelect.value = 'classic';
                addMessage('ai', 'Dosiahli ste limit 3 modelov za hodinu pre t√∫to kateg√≥riu. Moment√°lne m√¥≈æete pou≈æ√≠va≈• iba "Classic Model AI". Limit sa resetuje o 1 hodinu.');
                return;
            }

            addMessage('user', prompt);
            userInput.value = '';
            
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            
            // Z√≠skanie spr√°vneho promptu na z√°klade v√Ωberu kateg√≥rie
            const llmPrompt = getPromptForCategory(selectedCategory, prompt);

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: llmPrompt }] });

            const payload = { contents: chatHistory };
            // API kƒæ√∫ƒç bude automaticky poskytnut√Ω v prostred√≠, nemus√≠te ho zad√°va≈•
            const apiKey = "AIzaSyD0OIR4P5gjUBvVJfWUSYZmQGck_aKoVv8";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const maxRetries = 3;
            let success = false;
            let resultText = "Prep√°ƒçte, nieƒço sa pokazilo. Sk√∫ste to pros√≠m znova.";

            while (retries < maxRetries && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Pr√≠li≈° veƒæa po≈æiadaviek
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        console.warn(`Pr√≠li≈° veƒæa po≈æiadaviek. Sk√∫≈°am znova za ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Chyba API: ${response.status} ${response.statusText}. Podrobnosti: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        resultText = result.candidates[0].content.parts[0].text;
                        success = true;
                    } else {
                        throw new Error("Neoƒçak√°van√° ≈°trukt√∫ra odpovede.");
                    }
                } catch (error) {
                    console.error('Chyba pri volan√≠ API:', error);
                    retries++;
                    if (retries >= maxRetries) {
                        resultText = `Prep√°ƒçte, vyskytla sa chyba a nepodarilo sa n√°m vygenerova≈• k√≥d. Podrobnosti: ${error.message}.`;
                        break;
                    }
                    const delay = Math.pow(2, retries) * 1000;
                    console.warn(`Chyba. Sk√∫≈°am znova za ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // Inkrement√°cia poƒç√≠tadla pre obmedzen√© kateg√≥rie
            if (isRestrictedCategory && success) {
                incrementGenerationCount();
            }

            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            
            // Kontrola, ƒçi odpoveƒè obsahuje k√≥dov√Ω blok
            const codeMatch = resultText.match(/```(lua|Lua)?\s*([\s\S]+?)\s*```/);
            if (codeMatch) {
                addMessage('ai', codeMatch[2].trim(), true);
            } else {
                addMessage('ai', resultText);
            }
        }
    </script>
</body>
</html>



